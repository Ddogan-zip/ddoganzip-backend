# .github/workflows/deploy-swagger.yml

name: Deploy Swagger UI to GitHub Pages

# main 브랜치에 푸시될 때마다 이 워크플로우를 실행합니다.
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 리포지토리 코드를 워크플로우 환경으로 가져옵니다.
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 23 환경을 설정합니다. (프로젝트 버전에 맞게 변경)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle 실행 권한을 부여합니다.
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradle 빌드를 실행하여 openapi.yaml 파일을 생성합니다.
      - name: Generate OpenAPI spec
        run: ./gradlew generateOpenApiDocs
        env:
          SPRING_PROFILES_ACTIVE: test

      # 5. Swagger UI 파일 다운로드 및 설정
      - name: Setup Swagger UI
        run: |
          # 최종 배포할 폴더(swagger-ui)를 생성합니다.
          mkdir ./swagger-ui
          # Swagger UI 최신 버전을 다운로드하여 압축을 풉니다.
          wget https://github.com/swagger-api/swagger-ui/archive/refs/tags/v5.17.14.tar.gz
          tar -xvzf v5.17.14.tar.gz
          # dist 폴더 안의 웹 파일들을 swagger-ui 폴더로 옮깁니다.
          mv swagger-ui-5.17.14/dist/* ./swagger-ui/
          # 4단계에서 생성한 swagger.yaml 파일을 swagger-ui 폴더 안으로 복사합니다.
          cp build/docs/swagger.yaml ./swagger-ui/
          # swagger-ui의 index.html이 기본 예시 파일이 아닌, 우리 swagger.yaml을 보도록 수정합니다.
          sed -i 's|https://petstore.swagger.io/v2/swagger.json|./swagger.yaml|' ./swagger-ui/index.html

      # 6. 생성된 문서를 gh-pages 브랜치에 배포합니다.
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/docs # 1단계에서 생성된 파일이 있는 디렉토리
          # 필요하다면 배포 전 커밋 메시지를 지정할 수 있습니다.
          # commit_message: 'Deploy latest Swagger UI'